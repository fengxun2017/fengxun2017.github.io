---
title: 实现一个精简的BLE从机协议栈—1—链路层包格式和nrd52840上的实现
date: 2023/4/3
categories: 
- BLE协议栈
---

<center>
本文描述 BLE 链路层数据包的具体格式，并解析了如何在nordic nrf52840硬件上配置 BLE 数据包。
</center>

<!--more-->

***


- 本系列文章，基于`nordic nrf52840` MCU，来实现一个精简的 BLE 从机协议栈。
- 已经实现的协议栈地址：[https://github.com/fengxun2017/dh_ble/tree/dev](https://github.com/fengxun2017/dh_ble/tree/dev)，目前在dev分支进行更新开发。早期是基于`nrf51822`实现了`BLE 4.0`规范中从机协议栈中的必要部分，实现了可以和手机连接并传输数据。目前手上只有`nrf52840`了，当前基于`nrf52840`实现底层需要的驱动，并通过该系列文章，逐步修改一些上层不合理的地方。
- 该系列文章，涉及到的协议部分会基于`BLE 5.3`规范进行描述，但仍旧只实现**最简单、必要**的部分（能连上手机，进行通信即可），并基于`iphone`进行测试。因此，`android`可能会由于发送一些我没实现的指令，出现兼容性问题。
- 本系列文章，只是用来作为学习 BLE 协议的参考，从硬件层驱动，链路层，到上层协议，都以最直接，简单的方式来实现。



#### 1——BLE 链路层数据包基本形式：

BLE的链路层数据包基本格式如下所示：
![](./BleStack-link-packet/le-uncoded-packet.png)


BLE 5.0后新增了长距离（Long Range）传输特性，通过前向纠错编码（Forward Error Correction）实现低速率下更远距离的通信。
该特性本质是通过向数据中插入额外的冗余数据，使得一些传输错误错误，可以被恢复（例如，假设二进制信号"1"经过编码后变为"1111"，那么对方收到"0111"，"1011，""1101"，"1110"都可以认为实际数据是"1"。等于是通过发送原始数据4倍大小的数据，来实现一定的纠错能力）。

使用长距离特性时，链路层数的数据具有特定的包格式（LE CODED），
